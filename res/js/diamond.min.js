(function () {
    function n() {
    }

    function t() {
        this.inquiry = function (n) {
            return $.post("bj", n)
        };
    }

    function step1Bind(n) {
        $("#step1 dl li").bind("click",
            function () {
                if ($(this).parents("dl").hasClass("checkbox")) return $(this).toggleClass("selected"),
                    !1;
                if ($(this).hasClass("selected")) return !1;
                $(this).siblings(".selected").removeClass("selected");
                $(this).addClass("selected").parent().parent().parent().addClass("done");
                n.renderProgressbar();
                $(this).parents("dl").index("#step1 dl") + 1 == $("#step1 dl").not(".checkbox").length ? $("#step2").length && n.gotoQuestion($("#step2 .checkbox")) : n.gotoQuestion($(this).parent().parent().parent().next())
            });
    }

    function i() {
        var n = this,
            t = !1;
        this.init = function () {
            $(function () {
                step1Bind(n);
                $("#step2 .checkbox li").bind("click",
                    function () {
                        $(this).hasClass("selected") || $("#property_list dl.checkbox li[data-pid=" + $(this).data("pid") + "]").not($(this)).removeClass("selected");
                        $(this).toggleClass("selected")
                    });
                var t = $("#step3 dl li");
                t.bind("click",
                    function () {
                        $(this).hasClass("selected") || (t.filter(".selected").removeClass("selected"), $(this).addClass("selected"));
                        $("#footer").trigger("click")
                    });
                $("#footer_next").click(function () {
                    for (var r = $("#step1 dl"), i = 0; i < r.length; i++) if (!$(r[i]).hasClass("done") && !$(r[i]).hasClass("checkbox")) {
                        n.gotoQuestion($(r[i]));
                        return
                    }
                    var mainWeight = $("#mainWeight").val();
                    if (!mainWeight || isNaN(mainWeight) || mainWeight <= 0) {
                        alert("请输入正确的主钻重量!");
                        $("#mainWeight").focus();
                        return
                    }

                    t.filter(".selected").length ? $("#footer").trigger("click") : $("body").addClass("step_region_on");


                    $("#footer").trigger("click");
                });
                $("#header .back.step_region").click(function () {
                    $("body").removeClass("step_region_on")
                });
                $(".submit").click(function () {
                    //alert("start");

                    for (var u, f, e, o, i = [], r = $("#step0 dl"), t = 0; t < r.length; t++) if (!$(r[t]).hasClass("done") && !$(r[t]).hasClass("checkbox")) {
                        $("body").removeClass("step_region_on");
                        n.gotoQuestion($(r[t]));
                        return
                    }
                    for (var u, f, e, o, i = [], r = $("#step1 dl"), t = 0; t < r.length; t++) if (!$(r[t]).hasClass("done") && !$(r[t]).hasClass("checkbox")) {
                        $("body").removeClass("step_region_on");
                        n.gotoQuestion($(r[t]));
                        return
                    }
                    if (!$("#step3 dl li").hasClass("selected")) {
                        //alert("请选择地区");
                        return
                    }
                    //alert("aaaa");
                    $("#step1 li.selected").each(function (n, t) {
                        i.push($(t).data("id"))
                    });
                    u = $("#step2 .checkbox");
                    f = {};
                    u.find("li").each(function (n, t) {
                        var r = $(t).data("pid"),
                            e;
                        f[r] || (e = u.find("li.selected[data-pid=" + $(t).data("pid") + "]"), i.push(e.length ? e.data("pid") : ""), f[r] = !0)
                    });

                    var iii = $.grep(i, function (n) {
                        return $.trim(n).length > 0;
                    })
                    //console.log(iii);
                    e = $("#CaptchaInputText").val();
                    o = $("#CaptchaDeText").val();
                    $("#loading").removeClass("hide");

                    var diamondDesc = [];
                    var totalWeight = $("#totalWeight").val();
                    var mainWeight = $("#mainWeight").val();
                    var secWeight = $("#secWeight").val();
                    var gjsWeight = 0;
                    var mainAvg = "";
                    var secEstimatePrice = 0;
                    var zsFlage = 0; //钻饰flage
                    var numstr = ""; //重量描述
                    if (mainWeight)
                        diamondDesc.push("主钻重量:"+mainWeight+"ct");
                    if (secWeight) {
                        diamondDesc.push("辅钻重量:"+secWeight+"ct");
                        secEstimatePrice = secWeight * 1500;
                    }
                    if (totalWeight && mainWeight && secWeight) {
                        gjsWeight = parseFloat(totalWeight) - (parseFloat(mainWeight)+parseFloat(secWeight))*0.2;
                        zsFlage = 1;
                        numstr = "总重:"+totalWeight+"克"+",主钻"+mainWeight+"克拉,辅钻"+secWeight+"克拉";
                        diamondDesc.push("贵金属重量:"+gjsWeight+"g");
                        diamondDesc.push("总重量:"+totalWeight+"g");
                    } else {
                        numstr = mainWeight+"克拉";
                    }

                    var type = color = clarity = curt = cert = polish = symmetry = fluor = res = "";
                    for (var i=0; i<iii.length; i++) {
                        res = iii[i].split(":");
                        switch (res[0]) {
                            case "type":
                                type = res[1];
                                if (res[2])
                                    diamondDesc.push("贵金属类型:"+res[2]);
                                break;
                            case "Color":
                                color = res[1];
                                diamondDesc.push("颜色:"+color);
                                break;
                            case "Clarity":
                                clarity = res[1];
                                diamondDesc.push("净度:"+clarity);
                                break;
                            case "Cert":
                                cert = res[1];
                                diamondDesc.push("证书:"+cert);
                                break;
                            case "Curt":
                                curt = res[1];
                                diamondDesc.push("切工:"+cert);
                                break;
                            case "Polish":
                                polish = res[1];
                                diamondDesc.push("抛光:"+cert);
                                break;
                            case "Symmetry":
                                symmetry = res[1];
                                diamondDesc.push("对称:"+cert);
                                break;
                            case "Fluor":
                                fluor = res[1];
                                diamondDesc.push("荧光:"+cert);
                                break;
                        }

                    }
                    //console.log(diamondDesc);
                    // call diamond api
                    $.ajax({
                        dataType: 'script',
                        url: 'http://api.513ex.com:8080/api.php?pagejsnum=5&act=showdiamonds&openid=4b05a2f856368207d937898ef8c9b038',
                        data: {
                            S_1: mainWeight,
                            S_2: mainWeight,
                            Color: color,
                            Clarity: clarity,
                            Shape: 'A', //圆形
                            Cert: cert,
                            Cut: curt,
                            Polish: polish,
                            Symmetry: symmetry,
                            Fluor: fluor,
                            actype: 'json',
                            param: Math.random()

                        },

                        success: function () {

                            //var a = [];
                            var sum = 0;
                            //console.log(jsondata);
                            var length = jsondata.length;
                            //alert(length);
                            if (length <= 1) {
                                alert("没有相关钻石数据!请联系客服!");
                                location.reload();
                                return ;
                            } else if (length > 5) {
                                length = 5;
                            }

                            for (var i = 1, len = length; i < len; i++) {
                                //a.push(parseInt(jsondata[i].Rate * 1.5));
                                sum += parseInt(jsondata[i].Rate);
                            }
                            mainAvg = parseInt(sum/length)*0.8;
                            mainAvg = mainAvg.toFixed(1);

                            $("#pricerules").attr("value", type);
                            $("#mainAvg").attr("value", mainAvg);
                            $("#secPrice").attr("value", secEstimatePrice);
                            $("#gjsWeight").attr("value", gjsWeight);
                            $("#zsFlage").attr("value", zsFlage);
                            $("#cityId").attr("value", $("#step3 li.selected").data("cityid"));
                            $("#num").attr("value", numstr);
                            $("#diamondDesc").attr("value", diamondDesc);
                            $("#product").submit();
                        }
                    });
                    //location.href="bj?"+i.join(";");

                    //n.controller.inquiry({
                    //    PriceUnits: iii.join(";"),
                    //})


                    //$(this).hasClass("step_region") ? ($("#CaptchaInputText").val(""), n.controller.inquiry({
                    //    AuctionProductId: $(this).data("pid"),
                    //    ProductModelId: $(this).data("mid"),
                    //    PriceUnits: i.join(";"),
                    //    cityId: $("#step3 li.selected").data("cityid")
                    //})) : n.controller.inquiry({
                    //    AuctionProductId: $(this).data("pid"),
                    //    ProductModelId: $(this).data("mid"),
                    //    PriceUnits: i.join(";"),
                    //    cityId: $("#step3 li.selected").data("cityid"),
                    //    CaptchaInputText: e,
                    //    CaptchaDeText: o
                    //})
                })
                })
            };
            this.renderProgressbar = function () {
                var t = $("#property_list").find("dl.done").not(".checkbox").length + 1,
                    n = parseInt(t / $("#property_list").find("dl").not(".checkbox").length * 100);
                n >= 100 && (n = 100);
                $("#progressbar_cover").css({
                    width: n + "%"
                })
            };
            this.gotoQuestion = function (n) {
                return n.next() == null ? !1 : ($("html, body").animate({
                        scrollTop: n.offset().top - 150 + "px"
                    },
                    500, "swing"), !0)
            };
        }
        MVC(t, i, n)
    }

    )();