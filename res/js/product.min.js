(function() {
    function n() {
    }
    function t() {
        this.inquiry = function(n) {
            return $.post("bj", n)
        };
    }

    function step1Bind(n) {
        $("#step1 dl li").bind("click",
            function () {
                if ($(this).parents("dl").hasClass("checkbox")) return $(this).toggleClass("selected"),
                    !1;
                if ($(this).hasClass("selected")) return !1;
                $(this).siblings(".selected").removeClass("selected");
                $(this).addClass("selected").parent().parent().parent().addClass("done");
                n.renderProgressbar();
                $(this).parents("dl").index("#step1 dl") + 1 == $("#step1 dl").not(".checkbox").length ? $("#step2").length && n.gotoQuestion($("#step2 .checkbox")) : n.gotoQuestion($(this).parent().parent().parent().next())
            });
    }


    function i() {
        var n = this,
            t = !1;
        var productNoRules = 1;
        this.init = function() {
            //console.log(ruleMap[firstPvid]);
            productNoRules = 0;
            var u = ruleMap[firstPvid].body,
                y = u.length,
                v = "";
            var notRequired = "";
            var options = optionsLen = vv = "";
            if(y<=0) {
                tipsPopup("产品正在维护中,请稍候再试!");
                productNoRules = 1;
                return ;
            } else {
                productNoRules = 0;
            }
            for (var w = 0; w < y; w++) {
                var x = u[w];
                options = x.optionList;
                optionsLen = options.length;
                if (x.required) {

                    //v += '<li><a href="${baseurl}product/' + x.id + '"><span>' + (n * (s - 1) + w + 1) + "</span>" + x.name + "</a></li>"
                    v += '<dl><dt><span class="pff">'+ x.name + '</span></dt><dd><ul>';

                    for (var ww = 0; ww < optionsLen; ww++) {
                        var t = options[ww];
                        v += '<li data-id="' + t.id + '"><div class="value_text">'+ t.name + '<span class="gou"></span></div></li>';
                    }
                    v += '</ul></dd></dl>';
                } else {
                    for (var ww = 0; ww < optionsLen; ww++) {
                        var t = options[ww];
                        notRequired += '<li data-pid="' + t.id + '"><div class="value_text">'+ t.name + '<span class="gou"></span></div></li>';
                    }
                }
            }
            $("#step1").html(v);
            step1Bind(n);
            $("#step2UL").html(notRequired);
            $("#step2 .checkbox li").bind("click",
                function() {
                    $(this).hasClass("selected") || $("#property_list dl.checkbox li[data-pid=" + $(this).data("pid") + "]").not($(this)).removeClass("selected");
                    $(this).toggleClass("selected")
                });



            $(function() {
                $("#step0 dl li").bind("click",
                    function() {
                        if ($(this).parents("dl").hasClass("checkbox")) return $(this).toggleClass("selected"),
                            !1;
                        if ($(this).hasClass("selected")) return ! 1;
                        $(this).siblings(".selected").removeClass("selected");
                        $(this).addClass("selected").parent().parent().parent().addClass("done");
                        //n.renderProgressbar();
                        //$(this).parents("dl").index("#step1 dl") + 1 == $("#step1 dl").not(".checkbox").length ? $("#step2").length && n.gotoQuestion($("#step2 .checkbox")) : n.gotoQuestion($(this).parent().parent().parent().next())
                        var vpid = $("#step0 dl li.selected").data("id");
                        //console.log(vpid);
                        var u = ruleMap[vpid].body;
                            y = u.length,
                            v = "";
                        var notRequired = "";
                        var options = optionsLen = vv = "";
                        if(y<=0) {
                            tipsPopup("产品正在维护中,请稍候再试!");
                            productNoRules = 1;
                            return ;
                        } else {
                            productNoRules = 0;
                        }

                        for (var w = 0; w < y; w++) {
                            var x = u[w];
                            options = x.optionList;
                            optionsLen = options.length;
                            if (x.required) {

                                //v += '<li><a href="${baseurl}product/' + x.id + '"><span>' + (n * (s - 1) + w + 1) + "</span>" + x.name + "</a></li>"
                                v += '<dl><dt><span class="pff">'+ x.name + '</span></dt><dd><ul>';

                                for (var ww = 0; ww < optionsLen; ww++) {
                                    var t = options[ww];
                                    v += '<li data-id="' + t.id + '"><div class="value_text">'+ t.name + '<span class="gou"></span></div></li>';
                                }
                                v += '</ul></dd></dl>';
                            } else {
                                for (var ww = 0; ww < optionsLen; ww++) {
                                    var t = options[ww];
                                    notRequired += '<li data-pid="' + t.id + '"><div class="value_text">'+ t.name + '<span class="gou"></span></div></li>';
                                }
                            }
                        }
                        $("#step1").html(v);
                        step1Bind(n);
                        $("#step2UL").html(notRequired);
                        $("#step2 .checkbox li").bind("click",
                            function() {
                                $(this).hasClass("selected") || $("#property_list dl.checkbox li[data-pid=" + $(this).data("pid") + "]").not($(this)).removeClass("selected");
                                $(this).toggleClass("selected")
                            });

                    });


                step1Bind(n);
                var tt = $("#step3 dl li");
                tt.bind("click",
                    function() {
                        $(this).hasClass("selected") || (tt.filter(".selected").removeClass("selected"), $(this).addClass("selected"));
                        $("#footer").trigger("click")
                    });
                $("#footer_next").click(function() {
                    for (var u, f, e, o, i = [], r = $("#step0 dl"), t = 0; t < r.length; t++) if (!$(r[t]).hasClass("done") && !$(r[t]).hasClass("checkbox")) {
                        tipsPopup("请先选择渠道！");
                        n.gotoQuestion($(r[t]));
                        return
                    }
                    if (productNoRules) {
                        tipsPopup("产品正在维护中,请稍候再试!");
                        return ;
                    }
                    for (var r = $("#step1 dl"), i = 0; i < r.length; i++) if (!$(r[i]).hasClass("done") && !$(r[i]).hasClass("checkbox")) {
                        n.gotoQuestion($(r[i]));
                        return
                    }
                    tt.filter(".selected").length ? $("#footer").trigger("click") : $("body").addClass("step_region_on")
                    $("#footer").trigger("click");
                });
                $("#header .back.step_region").click(function() {
                    $("body").removeClass("step_region_on")
                });
                $(".submit").click(function() {
                    //alert("start");
                    for (var u, f, e, o, i = [], r = $("#step0 dl"), t = 0; t < r.length; t++) if (!$(r[t]).hasClass("done") && !$(r[t]).hasClass("checkbox")) {
                        tipsPopup("请先选择渠道！");
                        $("body").removeClass("step_region_on");
                        n.gotoQuestion($(r[t]));
                        return
                    }
                    for (var u, f, e, o, i = [], r = $("#step1 dl"), t = 0; t < r.length; t++) if (!$(r[t]).hasClass("done") && !$(r[t]).hasClass("checkbox")) {
                        $("body").removeClass("step_region_on");
                        n.gotoQuestion($(r[t]));
                        return
                    }
                    if (!$("#step3 dl li").hasClass("selected")) {
                        //alert("请选择地区");
                        return
                    }

                    $("#step1 li.selected").each(function(n, t) {
                        i.push($(t).data("id"))
                    });
                    u = $("#step2 .checkbox");
                    f = {};
                    u.find("li").each(function(n, t) {
                        var r = $(t).data("pid"),
                            e;
                        f[r] || (e = u.find("li.selected[data-pid=" + $(t).data("pid") + "]"), i.push(e.length ? e.data("pid") : ""), f[r] = !0)
                    });

                    if(i[0].indexOf("channel-") == 0) {
                        $("#channelId").attr("value", i[0].substr(8));
                        i[0]="";
                    }

                    var iii = $.grep(i, function(n) {return $.trim(n).length > 0;})

                    e = $("#CaptchaInputText").val();
                    o = $("#CaptchaDeText").val();
                    $("#loading").removeClass("hide");

                    $("#pricerules").attr("value", iii.join(","));
                    $("#cityId").attr("value", $("#step3 li.selected").data("cityid"));
                    $("#virtualPid").attr("value", $("#step0 dl li.selected").data("id"));
                    $("#product").submit();
                })
            })
        };
        this.renderProgressbar = function() {
            var t = $("#property_list").find("dl.done").not(".checkbox").length + 1,
                n = parseInt(t / $("#property_list").find("dl").not(".checkbox").length * 100);
            n >= 100 && (n = 100);
            $("#progressbar_cover").css({
                width: n + "%"
            })
        };
        this.gotoQuestion = function(n) {
            return n.next() == null ? !1 : ($("html, body").animate({
                    scrollTop: n.offset().top - 150 + "px"
                },
                500, "swing"), !0)
        };
    }
    MVC(t, i, n)
})();
